<html>
<head>
    <title>NiCad6 Clone Report</title>
    <style type="text/css">
        body {font-family:sans-serif;}
        table {background-color:white; border:0px; padding:0px; border-spacing:4px; width:auto; margin-left:30px; margin-right:auto;}
        td {background-color:rgba(192,212,238,0.8); border:0px; padding:8px; width:auto; vertical-align:top; border-radius:8px}
        pre {background-color:white; padding:4px;}
        a {color:darkblue;}
    </style>
</head>
<body>
<h2>NiCad6 Clone Report</h2>
<table>
<tr style="font-size:14pt">
<td><b>System:</b> &nbsp; Pywemo</td>
<td><b>Clone pairs:</b> &nbsp; 3</td>
<td><b>Clone classes:</b> &nbsp; 3</td>
</tr>
<tr style="font-size:12pt">
<td style="background-color:white">Clone type: &nbsp; 3-2</td>
<td style="background-color:white">Granularity: &nbsp; functions-blind</td>
<td style="background-color:white">Max diff threshold: &nbsp; 30%</td>
<td style="background-color:white">Clone size: &nbsp; 10 - 2500 lines</td>
<td style="background-color:white">Total functions-blind: &nbsp; 145</td>
</tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 1:</b> &nbsp; 2 fragments, nominal size 17 lines, similarity 70%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag53')" href="javascript:;">
Pywemo/tests/ouimeaux_device/test_bridge.py: 85-104
</a>
<div class="mid" id="frag53" style="display:none"><pre>
def test_bridge_getdevicestatus(bridge):
    status = bridge.bridge_getdevicestatus(LIGHT_ID)
    expected = b"".join(
        [
            b"&lt;DeviceStatus&gt;",
            b"&lt;IsGroupAction&gt;NO&lt;/IsGroupAction&gt;",
            b'&lt;DeviceID available="YES"&gt;F0D1B8000001420C&lt;/DeviceID&gt;',
            b"&lt;CapabilityID&gt;",
            b"10006,10008,10300,30008,30009,3000A,30301",
            b"&lt;/CapabilityID&gt;",
            b"&lt;CapabilityValue&gt;",
            b"0,120:0,45940:19594:50,,,,200:0",
            b"&lt;/CapabilityValue&gt;",
            b"&lt;LastEventTimeStamp&gt;0&lt;/LastEventTimeStamp&gt;",
            b"&lt;/DeviceStatus&gt;",
        ]
    )
    assert et.tostring(status) == expected


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag59')" href="javascript:;">
Pywemo/tests/ouimeaux_device/api/unit/test_rules.py: 39-59
</a>
<div class="mid" id="frag59" style="display:none"><pre>
def test_create_empty_db(sqldb):
    statements = set(
        line for line in sqldb.iterdump() if line.startswith("CREATE TABLE")
    )
    # flake8: noqa: E501 (long lines)
    assert statements == set(
        [
            # https://github.com/pywemo/pywemo/issues/61#issuecomment-748693894
            "CREATE TABLE RULES(RuleID PRIMARY KEY, Name TEXT NOT NULL, Type TEXT NOT NULL, RuleOrder INTEGER, StartDate TEXT, EndDate TEXT, State TEXT, Sync INTEGER);",
            "CREATE TABLE RULEDEVICES(RuleDevicePK INTEGER PRIMARY KEY AUTOINCREMENT, RuleID INTEGER, DeviceID TEXT, GroupID INTEGER, DayID INTEGER, StartTime INTEGER, RuleDuration INTEGER, StartAction REAL, EndAction REAL, SensorDuration INTEGER, Type INTEGER, Value INTEGER, Level INTEGER, ZBCapabilityStart TEXT, ZBCapabilityEnd TEXT, OnModeOffset INTEGER, OffModeOffset INTEGER, CountdownTime INTEGER, EndTime INTEGER);",
            "CREATE TABLE DEVICECOMBINATION(DeviceCombinationPK INTEGER PRIMARY KEY AUTOINCREMENT, RuleID INTEGER, SensorID TEXT, SensorGroupID INTEGER, DeviceID TEXT, DeviceGroupID INTEGER);",
            "CREATE TABLE GROUPDEVICES(GroupDevicePK INTEGER PRIMARY KEY AUTOINCREMENT, GroupID INTEGER, DeviceID TEXT);",
            "CREATE TABLE LOCATIONINFO(LocationPk INTEGER PRIMARY KEY AUTOINCREMENT, cityName TEXT, countryName TEXT, latitude TEXT, longitude TEXT, countryCode TEXT, region TEXT);",
            "CREATE TABLE BLOCKEDRULES(Primarykey INTEGER PRIMARY KEY AUTOINCREMENT, ruleId TEXT);",
            "CREATE TABLE RULESNOTIFYMESSAGE(RuleID INTEGER PRIMARY KEY AUTOINCREMENT, NotifyRuleID INTEGER, Message TEXT, Frequency INTEGER);",
            "CREATE TABLE SENSORNOTIFICATION(SensorNotificationPK INTEGER PRIMARY KEY AUTOINCREMENT, RuleID INTEGER, NotifyRuleID INTEGER, NotificationMessage TEXT, NotificationDuration INTEGER);",
            "CREATE TABLE TARGETDEVICES(TargetDevicesPK INTEGER PRIMARY KEY AUTOINCREMENT, RuleID INTEGER, DeviceID TEXT, DeviceIndex INTEGER);",
        ]
    )


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 2:</b> &nbsp; 2 fragments, nominal size 24 lines, similarity 76%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag62')" href="javascript:;">
Pywemo/tests/ouimeaux_device/api/unit/test_rules.py: 92-127
</a>
<div class="mid" id="frag62" style="display:none"><pre>
def test_add_remove(sqldb):
    db = rules_db.RulesDb(sqldb, MOCK_UDN, MOCK_NAME)

    # Rules
    assert len(db._rules) == 0
    rule = db.add_rule(
        rules_db.RulesRow(
            RuleID=501,
            Name="Long Press Rule",
            Type=MOCK_RULE_TYPE,
            State=1,
        )
    )
    assert len(db._rules) == 1
    db.remove_rule(rule)
    assert len(db._rules) == 0

    # RuleDevices
    assert len(db._rule_devices) == 0
    device = db.add_rule_devices(
        rules_db.RuleDevicesRow(RuleDevicePK=1, RuleID=501, DeviceID=MOCK_UDN)
    )
    assert len(db._rule_devices) == 1
    db.remove_rule_devices(device)
    assert len(db._rule_devices) == 0

    # TargetDevices
    assert len(db._target_devices) == 0
    target = db.add_target_devices(
        rules_db.TargetDevicesRow(RuleID=501, DeviceID=MOCK_TARGET_UDN)
    )
    assert len(db._target_devices) == 1
    db.remove_target_devices(target)
    assert len(db._target_devices) == 0


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag63')" href="javascript:;">
Pywemo/tests/ouimeaux_device/api/unit/test_rules.py: 128-159
</a>
<div class="mid" id="frag63" style="display:none"><pre>
def test_clear_all(sqldb):
    db = rules_db.RulesDb(sqldb, MOCK_UDN, MOCK_NAME)
    rule = db.add_rule(
        rules_db.RulesRow(
            RuleID=501,
            Name="Long Press Rule",
            Type=MOCK_RULE_TYPE,
            State=1,
        )
    )
    assert len(db._rules) == 1

    # RuleDevices
    assert len(db._rule_devices) == 0
    device = db.add_rule_devices(
        rules_db.RuleDevicesRow(RuleDevicePK=1, RuleID=501, DeviceID=MOCK_UDN)
    )
    assert len(db._rule_devices) == 1

    # TargetDevices
    assert len(db._target_devices) == 0
    target = db.add_target_devices(
        rules_db.TargetDevicesRow(RuleID=501, DeviceID=MOCK_TARGET_UDN)
    )
    assert len(db._target_devices) == 1

    db.clear_all()
    assert len(db._rules) == 0
    assert len(db._rule_devices) == 0
    assert len(db._target_devices) == 0


</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<br>
<table style="width:1000px; border:2px solid lightgrey; border-radius:8px;">
<tr><td style="background-color:white">
<p style="font-size:14pt"><b>Class 3:</b> &nbsp; 2 fragments, nominal size 21 lines, similarity 72%</p>
<table cellpadding=4 border=2>
<tr>
<td width="auto">
<a onclick="javascript:ShowHide('frag72')" href="javascript:;">
Pywemo/tests/ouimeaux_device/api/unit/test_rules.py: 277-307
</a>
<div class="mid" id="frag72" style="display:none"><pre>
def test_rules_db_from_device_404():
    mock_response = create_autospec(urllib3.HTTPResponse, instance=True)
    mock_response.status = 404

    class Device:
        name = MOCK_NAME
        udn = MOCK_UDN
        session = Session("http://localhost/")

        class rules:
            @staticmethod
            def FetchRules():
                return {
                    "ruleDbVersion": "1",
                    "ruleDbPath": "http://localhost/rules.db",
                }

    completed_with_no_exceptions = False
    with patch(
        "urllib3.PoolManager.request", return_value=mock_response
    ) as mock_request:
        with rules_db.rules_db_from_device(Device) as db:
            mock_request.assert_called_once_with(
                method="GET", url="http://localhost/rules.db"
            )
        assert len(db.rules) == 0
        completed_with_no_exceptions = True

    assert completed_with_no_exceptions


</pre></div>
</td>
<td width="auto">
<a onclick="javascript:ShowHide('frag75')" href="javascript:;">
Pywemo/tests/ouimeaux_device/api/unit/test_rules.py: 324-346
</a>
<div class="mid" id="frag75" style="display:none"><pre>
def test_sqlite_errors_raised():
    mock_response = create_autospec(urllib3.HTTPResponse, instance=True)
    mock_response.status = 404

    class Device:
        name = MOCK_NAME
        udn = MOCK_UDN
        session = Session("http://localhost/")

        class rules:
            @staticmethod
            def FetchRules():
                return {
                    "ruleDbVersion": "1",
                    "ruleDbPath": "http://localhost/rules.db",
                }

    with patch(
        "urllib3.PoolManager.request", return_value=mock_response
    ) as mock_request:
        with pytest.raises(RulesDbQueryError):
            with rules_db.rules_db_from_device(Device) as db:
                raise sqlite3.OperationalError("test")
</pre></div>
</td>
</tr><tr>
</tr>
</table>
</td></tr>
</table>
<script language="JavaScript">
function ShowHide(divId) { 
    if(document.getElementById(divId).style.display == 'none') {
        document.getElementById(divId).style.display='block';
    } else { 
        document.getElementById(divId).style.display = 'none';
    } 
}
</script>
</body>
</html>
